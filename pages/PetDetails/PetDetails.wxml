<!--pages/PetDetails/PetDetails.wxml-->
<view class="container">
  <!-- 宠物图片轮播 -->
  <view class="pet-image-section" wx:if="{{pet}}">
    <swiper 
      class="image-swiper" 
      indicator-dots="{{imageCount > 1}}" 
      indicator-color="rgba(255, 255, 255, 0.5)"
      indicator-active-color="#ffffff"
      autoplay="{{imageCount > 1}}" 
      interval="5000" 
      duration="500"
      bindchange="onSwiperChange"
      circular="{{imageCount > 1}}"
      current="{{currentImageIndex}}"
    >
      <swiper-item wx:for="{{(pet.images && pet.images.length > 0) ? pet.images : [pet.processedImageUrl]}}" wx:key="*this">
        <image 
          class="pet-image" 
          src="{{item}}" 
          mode="aspectFill" 
          binderror="onImageError" 
          bindtap="previewImages"
          data-index="{{index}}"
          lazy-load="true"
        />
      </swiper-item>
    </swiper>
    

    
    <!-- 图片计数器 -->
    <view class="image-counter" wx:if="{{imageCount > 1}}">
      <text class="counter-text">{{currentImageIndex + 1}}/{{imageCount}}</text>
    </view>
    
    <view class="image-overlay">
      <view class="back-btn" bindtap="goBack">
        <text class="back-icon">‹</text>
      </view>
      <view class="share-btn" bindtap="sharePet">
        <text class="share-icon">📤</text>
      </view>
    </view>
    
    <!-- 轮播提示 -->
    <view class="swipe-hint" wx:if="{{imageCount > 1}}">
      <text class="hint-text">滑动或点击箭头查看更多图片</text>
    </view>
  </view>

  <!-- 宠物基本信息卡片 -->
  <view class="pet-info-card" wx:if="{{pet}}">
    <view class="pet-header">
      <view class="pet-title-section">
  <text class="pet-name">{{pet.name}}</text>
  <view class="pet-badges">
          <view class="status-badge {{pet.isAdopt === '待领养' ? 'adoptable' : 'adopted'}}">
            <text class="badge-text">{{pet.isAdopt}}</text>
          </view>
          <view class="health-badge {{pet.healthStatus === '健康' ? 'healthy' : 'sick'}}">
            <text class="badge-text">{{pet.healthStatus}}</text>
          </view>
        </view>
      </view>
      
  <view class="card-actions">
    <view class="like-section" catchtap="toggleLike" data-target-id="{{pet.id}}">
      <view class="like-icon {{likeStates[pet.id] ? 'liked' : ''}}">
        {{likeStates[pet.id] ? '❤️' : '🤍'}}
      </view>
    </view>
  </view>
  
  <view class="pet-meta-grid">
        <view class="meta-item">
          <view class="meta-icon">🐕</view>
          <view class="meta-content">
            <text class="meta-label">品种</text>
            <text class="meta-value">{{pet.breed}}</text>
          </view>
        </view>
        <view class="meta-item">
          <view class="meta-icon">🎂</view>
          <view class="meta-content">
            <text class="meta-label">年龄</text>
            <text class="meta-value">{{pet.age}}岁</text>
          </view>
        </view>
        <view class="meta-item">
          <view class="meta-icon">⚧</view>
          <view class="meta-content">
            <text class="meta-label">性别</text>
            <text class="meta-value">{{pet.gender}}</text>
          </view>
        </view>
        <view class="meta-item">
          <view class="meta-icon">📍</view>
          <view class="meta-content">
            <text class="meta-label">地区</text>
            <text class="meta-value">{{pet.location}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="pet-description">
      <text class="description-title">详细介绍</text>
      <text class="description-text">{{pet.description || '暂无详细介绍'}}</text>
    </view>
  </view>

  <!-- 疫苗信息卡片 -->
  <view class="vaccine-card" wx:if="{{!vaccineLoading && !vaccineError}}">
    <view class="card-header">
      <view class="card-icon">💉</view>
      <text class="card-title">健康档案</text>
    </view>
    
    <view wx:if="{{vaccineInfo}}" class="vaccine-content">
      <view class="info-grid">
        <view class="info-item">
          <text class="info-label">疫苗记录</text>
          <text class="info-value">{{vaccineInfo.vaccineRecord || '无'}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">绝育状态</text>
          <text class="info-value {{vaccineInfo.sterilization === 1 ? 'success' : 'warning'}}">
            {{vaccineInfo.sterilization === 1 ? '已绝育' : '未绝育'}}
          </text>
        </view>
        <view class="info-item">
          <text class="info-label">最近体检</text>
          <text class="info-value">{{vaccineInfo.lastCheckupStr || '无'}}</text>
        </view>
      </view>
    </view>
    
    <view wx:else class="empty-state">
      <view class="empty-icon">📋</view>
      <text class="empty-text">暂无健康档案</text>
      <text class="empty-desc">该宠物暂无详细的健康信息记录</text>
    </view>
  </view>
  
  <view wx:if="{{vaccineLoading}}" class="loading-state">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载健康档案中...</text>
  </view>
  
  <view wx:if="{{vaccineError}}" class="error-state">
    <view class="error-icon">⚠️</view>
    <text class="error-text">健康档案获取失败</text>
    <button class="retry-btn" bindtap="retryLoadVaccine">
      <text class="btn-text">重试</text>
    </button>
  </view>

  <!-- 评论区 - 直接显示在主页面 -->
  <view class="comments-section" wx:if="{{pet}}">
    <view class="section-header">
      <text class="section-title">评论</text>
      <text class="section-count">({{commentCount || 0}})</text>
    </view>

    <!-- 评论输入框 -->
    <view class="comment-input-container">
      <input class="comment-input" placeholder="写下你的评论..." bindinput="onCommentInput" value="{{commentContent}}"/>
      <button class="send-btn" bindtap="submitComment" disabled="{{commentContent.trim()}}">发送</button>
    </view>

    <!-- 评论列表 -->
    <scroll-view class="comments-list" scroll-y="true">
      <block wx:for="{{comments}}" wx:key="id">
        <view class="comment-item" id="comment-{{item.id}}">
          <view class="comment-header">
            <view class="avatar" wx:if="{{item.userAvatar}}">
              <image src="{{item.userAvatar}}" mode="aspectFill"></image>
            </view>
            <view class="avatar" wx:else>
              <text class="avatar-text">{{item.userName ? item.userName.substring(0, 1) : '未'}}</text>
            </view>
            <view class="comment-info">
              <text class="user-name">{{item.userName || '匿名用户'}}</text>
              <text class="comment-time">{{item.createTime || '刚刚'}}</text>
            </view>
            <view class="comment-actions">
              <view class="action-btn reply-btn" bindtap="showReplyBox" data-id="{{item.id}}" data-name="{{item.userName}}">
                <text class="action-icon">💬</text>
                <text class="action-text">回复</text>
              </view>
              <view class="action-btn delete-btn" bindtap="deleteComment" data-id="{{item.id}}" wx:if="{{item.userId === userId}}">
                <text class="action-icon">🗑️</text>
              </view>
            </view>
          </view>
          <view class="comment-content">
            <text wx:if="{{item.parentId && item.parentUserName}}">@{{item.parentUserName}}: </text>
            <text>{{item.content}}</text>
          </view>

          <!-- 二级评论 -->
          <view class="reply-list" wx:if="{{item.replies && item.replies.length > 0}}">
            <block wx:for="{{item.replies}}" wx:key="id" wx:for-item="reply">
              <view class="reply-item" id="comment-{{reply.id}}">
                <view class="comment-header">
                  <view class="avatar" wx:if="{{reply.userAvatar}}">
                    <image src="{{reply.userAvatar}}" mode="aspectFill"></image>
                  </view>
                  <view class="avatar" wx:else>
                    <text class="avatar-text">{{reply.userName ? reply.userName.substring(0, 1) : '未'}}</text>
                  </view>
                  <view class="comment-info">
                    <text class="user-name">{{reply.userName || '匿名用户'}}</text>
                    <text class="comment-time">{{reply.createTime || '刚刚'}}</text>
                  </view>
                  <view class="comment-actions">
                    <view class="action-btn reply-btn" bindtap="showReplyBox" data-id="{{reply.id}}" data-name="{{reply.userName}}">
                      <text class="action-icon">💬</text>
                      <text class="action-text">回复</text>
                    </view>
                    <view class="action-btn delete-btn" bindtap="deleteComment" data-id="{{reply.id}}" wx:if="{{reply.userId === userId}}">
                      <text class="action-icon">🗑️</text>
                    </view>
                  </view>
                </view>
                <view class="comment-content">
                  <text wx:if="{{reply.parentId && reply.parentUserName}}">@{{reply.parentUserName}}: </text>
                  <text>{{reply.content}}</text>
                </view>



                <!-- 二级评论的回复输入框 -->
                <view class="reply-input-container" wx:if="{{showReplyId === reply.id}}">
                  <input class="reply-input" placeholder="回复 {{reply.userName}}..." bindinput="onReplyInput" value="{{replyContent}}"/>
                  <view class="reply-btns">
                    <button class="send-btn" bindtap="submitReply" data-id="{{reply.id}}" disabled="{{replyContent.trim()}}">发送</button>
                  </view>
                </view>
              </view>
            </block>
          </view>

          <!-- 一级评论的回复输入框 -->
          <view class="reply-input-container" wx:if="{{showReplyId === item.id}}">
            <input class="reply-input" placeholder="回复 {{item.userName}}..." bindinput="onReplyInput" value="{{replyContent}}"/>
            <view class="reply-btns">
              <button class="send-btn" bindtap="submitReply" data-id="{{item.id}}" disabled="{{replyContent.trim()}}">发送</button>
            </view>
          </view>
        </view>
      </block>
      <view class="no-comments" wx:if="{{comments.length === 0}}">
        <text>暂无评论，快来抢沙发吧~</text>
      </view>
    </scroll-view>
  </view>

  <!-- 防止冒泡事件 -->
  <view class="stop-propagation" catchtap="stopPropagation"></view>

  <!-- 领养按钮吸底 -->
  <view class="adopt-btn-fixed">
    <button class="adopt-btn" bindtap="onAdopt" disabled="{{pet.isAdopt !== '待领养'}}">
      <text class="btn-icon">🏠</text>
      <text class="btn-text">{{pet.isAdopt === '待领养' ? '申请领养' : '已被领养'}}</text>
    </button>
  </view>

  <!-- 领养申请表单弹窗 -->
  <view wx:if="{{showAdoptForm}}" class="adopt-form-mask" bindtap="onCloseAdoptForm">
    <view class="adopt-form" catchtap="stopPropagation">
      <view class="form-header">
        <text class="form-title">领养申请</text>
        <view class="form-close" bindtap="onCloseAdoptForm">×</view>
      </view>
      
      <view class="form-content">
        <view class="form-item">
          <text class="form-label">申请理由 <text class="required">*</text></text>
          <textarea 
            class="form-input" 
            placeholder="请详细说明您想要领养这只宠物的理由..." 
            value="{{applyReason}}" 
            bindinput="onApplyReasonInput"
            maxlength="500"
          ></textarea>
          <text class="char-count">{{applyReason.length}}/500</text>
        </view>
        
        <view class="form-item">
          <text class="form-label">养宠经验 <text class="required">*</text></text>
          <textarea 
            class="form-input" 
            placeholder="请描述您的养宠经验，包括是否养过宠物、了解宠物护理等..." 
            value="{{petExperience}}" 
            bindinput="onPetExperienceInput"
            maxlength="500"
          ></textarea>
          <text class="char-count">{{petExperience.length}}/500</text>
        </view>
        
        <view wx:if="{{adoptError}}" class="form-error">
          <text class="error-icon">⚠️</text>
          <text class="error-text">{{adoptErrorMsg}}</text>
        </view>
        
        <view class="form-buttons">
          <button class="form-btn cancel" bindtap="onCloseAdoptForm">
            <text class="btn-text">取消</text>
          </button>
          <button class="form-btn primary" loading="{{adoptLoading}}" bindtap="submitAdoptionApply">
            <text class="btn-text">{{adoptLoading ? '提交中...' : '提交申请'}}</text>
          </button>
        </view>
      </view>
    </view>
  </view>
</view>